<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoDrift - 3D æ¿å¡Šæ§‹é€ æ¼”è®Šæ¨¡æ“¬å™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ React å’Œ ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- è¼‰å…¥ Babel é€²è¡Œ JSX è½‰è­¯ (åœ¨ç€è¦½å™¨ä¸­åŸ·è¡Œ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- è¼‰å…¥ Three.js åŠå…¶æ§åˆ¶å™¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        
        /* æ’­æ”¾æŒ‰éˆ•å‹•ç•« */
        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
    </style>
</head>
<body class="bg-slate-900">
    <div id="root">
        <!-- React App æœƒè¢«æ¸²æŸ“åˆ°é€™è£¡ -->
    </div>

    <script type="text/babel">
        // ç‚ºäº†åœ¨å–®ä¸€ HTML æ–‡ä»¶ä¸­é‹è¡Œï¼Œæˆ‘å€‘å°‡æ‰€æœ‰ React ä»£ç¢¼æ”¾åœ¨é€™è£¡ã€‚
        // è«‹æ³¨æ„ï¼šæ­¤è™•å·²å°‡ 'import' æ›¿æ›ç‚ºå…¨åŸŸå­˜å– (ä¾‹å¦‚: THREE.OrbitControls)ã€‚

        // -----------------------------------------------------------------------------
        // API è¨­å®š
        // -----------------------------------------------------------------------------
        // * IMPORTANT: REPLACE THIS with your actual Gemini API Key for AI features to work *
        const apiKey = "AIzaSyDdVVMuxFaQiTHskDWafpYkOWrSma-v_Q0"; 

        // -----------------------------------------------------------------------------
        // æ•¸æ“šèˆ‡å¸¸æ•¸å®šç¾©
        // -----------------------------------------------------------------------------
        const { useState, useEffect, useRef, useMemo } = React;
        const Play = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const Pause = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>;
        const Info = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;
        const Globe = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"></path><path d="M2 12h20"></path></svg>;
        const RotateCcw = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-3.62 1.09L5 7"></path><path d="M5 3v4h4"></path></svg>;
        const Sparkles = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3v14"></path><path d="M10 5l4 4"></path><path d="M14 5l-4 4"></path><path d="M10 17l4 4"></path><path d="M14 17l-4 4"></path></svg>;
        const MessageSquare = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
        const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Send = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;

        const GEOLOGICAL_ERAS = [
          { name: "äºŒç–Šç´€ (Permian)", time: 250, description: "ç›¤å¤å¤§é™¸ (Pangea) å½¢æˆï¼Œæ‰€æœ‰é™¸å¡Šèšåˆåœ¨ä¸€èµ·ã€‚æ°£å€™ä¹¾ç‡¥ï¼Œçˆ¬è¡Œå‹•ç‰©é–‹å§‹ç¹è¡ã€‚" },
          { name: "ä¸‰ç–Šç´€ (Triassic)", time: 200, description: "ç›¤å¤å¤§é™¸é–‹å§‹åˆ†è£‚ã€‚æé¾å‡ºç¾ï¼Œæœ€æ—©çš„å“ºä¹³å‹•ç‰©èª•ç”Ÿã€‚" },
          { name: "ä¾ç¾…ç´€ (Jurassic)", time: 150, description: "å‹äºå¤§é™¸èˆ‡å²¡ç“¦ç´å¤§é™¸åˆ†é›¢ã€‚æé¾çµ±æ²»åœ°çƒï¼Œæ°£å€™æº«æš–æ¿•æ½¤ã€‚" },
          { name: "ç™½å Šç´€ (Cretaceous)", time: 100, description: "å¤§é™¸æ¿å¡Šé€²ä¸€æ­¥åˆ†é›¢ï¼Œå¤§è¥¿æ´‹å½¢æˆã€‚é–‹èŠ±æ¤ç‰©å‡ºç¾ã€‚" },
          { name: "å¤è¿‘ç´€ (Paleogene)", time: 50, description: "æé¾æ»…çµ•å¾Œï¼Œå“ºä¹³å‹•ç‰©å¿«é€Ÿæ¼”åŒ–ã€‚å°åº¦æ¿å¡Šæ’æ“Šæ­äºæ¿å¡Šï¼Œå–œé¦¬é¦¬æ‹‰é›…å±±å‡èµ·ã€‚" },
          { name: "ç¾ä»£ (Present)", time: 0, description: "ç•¶å‰çš„åœ°è²Œã€‚ä¸ƒå¤§æ´²äº”å¤§æ´‹å®šå‹ï¼Œäººé¡æ–‡æ˜ç™¼å±•ã€‚" },
        ];

        const PLATES = {
          NA: { id: 1, color: '#4ade80', axis: new THREE.Vector3(0, 1, 0), speed: 0.5, name: 'åŒ—ç¾æ¿å¡Š' },
          SA: { id: 2, color: '#22c55e', axis: new THREE.Vector3(0.2, 1, 0), speed: 0.4, name: 'å—ç¾æ¿å¡Š' },
          EU: { id: 3, color: '#16a34a', axis: new THREE.Vector3(0, 1, 0.1), speed: 0.2, name: 'æ­äºæ¿å¡Š' },
          AF: { id: 4, color: '#15803d', axis: new THREE.Vector3(0.1, 1, -0.1), speed: 0.3, name: 'éæ´²æ¿å¡Š' },
          AU: { id: 5, color: '#86efac', axis: new THREE.Vector3(-0.5, 1, 0), speed: 0.8, name: 'æ¾³æ´²æ¿å¡Š' },
          AN: { id: 6, color: '#f0fdf4', axis: new THREE.Vector3(1, 0, 0), speed: 0.1, name: 'å—æ¥µæ¿å¡Š' },
          IN: { id: 7, color: '#bbf7d0', axis: new THREE.Vector3(-1, 0.5, 0), speed: 1.5, name: 'å°åº¦æ¿å¡Š' },
        };

        const seededRandom = (seed) => {
          const x = Math.sin(seed++) * 10000;
          return x - Math.floor(x);
        };

        // ---------------------------------------------------------------------------
        // Main App Component
        // ---------------------------------------------------------------------------
        function App() {
          const mountRef = useRef(null);
          const [loading, setLoading] = useState(true);
          const [year, setYear] = useState(250); // å–®ä½ï¼šç™¾è¬å¹´å‰ (Ma)
          const [isPlaying, setIsPlaying] = useState(false);
          const [currentEra, setCurrentEra] = useState(GEOLOGICAL_ERAS[0]);

          // AI Chat State (åŠŸèƒ½ä¸€ï¼šæ™‚ç©ºå°éŠ)
          const [chatOpen, setChatOpen] = useState(false);
          const [messages, setMessages] = useState([
            { role: 'system', text: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI æ™‚ç©ºå°éŠã€‚ç§»å‹•æ™‚é–“è»¸ï¼Œéš¨æ™‚å•æˆ‘é—œæ–¼é‚£å€‹æ™‚ä»£çš„å•é¡Œï¼" }
          ]);
          const [aiInput, setAiInput] = useState("");
          const [isAiLoading, setIsAiLoading] = useState(false);

          // AI Headline State (åŠŸèƒ½äºŒï¼šæ™‚ä»£é ­æ¢)
          const [eraHeadline, setEraHeadline] = useState(null);
          const [isHeadlineLoading, setIsHeadlineLoading] = useState(false);

          // AI Image State (åŠŸèƒ½ä¸‰ï¼šæ™‚ä»£å½±åƒç”Ÿæˆ)
          const [generatedImageURL, setGeneratedImageURL] = useState(null);
          const [isImageGenerating, setIsImageGenerating] = useState(false);

          // ç”¨æ–¼ Three.js çš„ Refs
          const sceneRef = useRef(null);
          const cameraRef = useRef(null);
          const rendererRef = useRef(null);
          const controlsRef = useRef(null);
          const globeGroupRef = useRef(null);
          const landMeshesRef = useRef([]); 

          // ---------------------------------------------------------------------------
          // Gemini API Integration - æ™‚ç©ºå°éŠèŠå¤© (åŠŸèƒ½ä¸€)
          // ---------------------------------------------------------------------------
          const callGemini = async (userPrompt) => {
            if (!userPrompt.trim()) return;
            if (!apiKey) {
                setMessages([...messages, { role: 'assistant', text: "éŒ¯èª¤ï¼šè«‹å…ˆåœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ‚¨çš„ API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ã€‚" }]);
                return;
            }

            const newMessages = [...messages, { role: 'user', text: userPrompt }];
            setMessages(newMessages);
            setAiInput("");
            setIsAiLoading(true);

            const systemPrompt = `
              You are an enthusiastic AI Time-Travel Guide and Geologist.
              The user is currently viewing a 3D simulation of Earth at ${year} million years ago (Era: ${currentEra.name}).
              
              Context:
              - Current Time: ${year} Ma (Million Years Ago)
              - Geological Era: ${currentEra.name}
              - Description: ${currentEra.description}
              
              Your Goal:
              Answer the user's question specifically about this time period. 
              Keep your answer concise (under 100 words), educational, and fun.
              If the user asks about the future or past relative to this time, explain based on your geological knowledge.
              Use emojis âœ¨ğŸ¦•ğŸŒ‹ sparingly to make it engaging.
              Language: Traditional Chinese (ç¹é«”ä¸­æ–‡).
            `;

            try {
              const response = await fetch(
                https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey},
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                  }),
                }
              );

              if (!response.ok) throw new Error('API request failed');

              const data = await response.json();
              const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæ™‚ç©ºé€šè¨Šä¼¼ä¹å—åˆ°å¹²æ“¾ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";

              setMessages([...newMessages, { role: 'assistant', text: aiResponse }]);

            } catch (error) {
              console.error("Gemini API Error:", error);
              setMessages([...newMessages, { role: 'assistant', text: "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" }]);
            } finally {
              setIsAiLoading(false);
            }
          };

          const handleQuickAction = (action) => {
            let prompt = "";
            switch (action) {
                case 'animals': prompt = "é€™å€‹æ™‚ä»£æœ‰ä»€éº¼ä»£è¡¨æ€§çš„å‹•ç‰©ï¼Ÿ"; break;
                case 'climate': prompt = "ç¾åœ¨çš„æ°£å€™æ„Ÿè¦ºå¦‚ä½•ï¼Ÿé©åˆäººé¡ç”Ÿå­˜å—ï¼Ÿ"; break;
                case 'continents': prompt = "ç¾åœ¨çš„å¤§é™¸æ¿å¡Šé•·ä»€éº¼æ¨£å­ï¼Ÿ"; break;
                default: prompt = "å‘Šè¨´æˆ‘ä¸€å€‹é—œæ–¼é€™å€‹æ™‚ä»£çš„æœ‰è¶£å†·çŸ¥è­˜ï¼";
            }
            // Add system message if chat is closed
            if (!chatOpen) {
                 setMessages([{ role: 'system', text: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI æ™‚ç©ºå°éŠã€‚ç§»å‹•æ™‚é–“è»¸ï¼Œéš¨æ™‚å•æˆ‘é—œæ–¼é‚£å€‹æ™‚ä»£çš„å•é¡Œï¼" }]);
                 setChatOpen(true);
            }
            callGemini(prompt);
          };
          
          // ---------------------------------------------------------------------------
          // Gemini API Integration - æ™‚ä»£é ­æ¢ç”Ÿæˆå™¨ (åŠŸèƒ½äºŒ)
          // ---------------------------------------------------------------------------
          const generateEraHeadline = async () => {
            if (!apiKey) { setEraHeadline({ headline: "è«‹å¡«å…¥ API Key", summary: "AI åŠŸèƒ½éœ€è¦æœ‰æ•ˆçš„ API Keyã€‚" }); return; }

            setIsHeadlineLoading(true);
            setEraHeadline(null);

            const userPrompt = `Generate a captivating, single-sentence headline (max 12 Traditional Chinese characters) and a short, dramatic summary (max 30 Traditional Chinese characters) for the year ${year} Ma. Focus on the most significant event in the current era (${currentEra.name}) and its position in the timeline. 
            Format the output STRICTLY as: "Headline | Summary". If the current year is the exact start/end of an era (e.g., 250Ma or 0Ma), highlight that transition.`;

            const systemPrompt = `
              You are an AI Historical News Reporter. The user wants a dramatic summary of the current geological period.
              Context: ${year} Ma (${currentEra.name}). Description: ${currentEra.description}
              Output MUST be in the exact format: "Headline | Summary". Use Traditional Chinese (ç¹é«”ä¸­æ–‡).
            `;

            let result = null;
            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(
                        https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey},
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: userPrompt }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] }
                            }),
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        result = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (result) break; 
                    }

                } catch (error) {
                    console.warn(Headline API call failed, retrying in ${delay}ms...);
                }

                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }

            if (result) {
                const parts = result.split('|').map(s => s.trim());
                const headline = parts[0] || "é‡å¤§äº‹ä»¶ç™¼ç”Ÿï¼";
                const summary = parts[1] || "AIç”Ÿæˆæ‘˜è¦å¤±æ•—ã€‚è«‹é‡è©¦ã€‚";
                setEraHeadline({ headline, summary });
            } else {
                setEraHeadline({ headline: "æ™‚ç©ºè¨Šè™Ÿä¸­æ–·", summary: "ç„¡æ³•å–å¾—è©²å¹´ä»£çš„æ­·å²é ­æ¢ã€‚" });
            }
            
            setIsHeadlineLoading(false);
          };
          
          // ---------------------------------------------------------------------------
          // Gemini API Integration - æ™‚ä»£å½±åƒç”Ÿæˆå™¨ (åŠŸèƒ½ä¸‰)
          // ---------------------------------------------------------------------------
          const generateEraImage = async () => {
             if (!apiKey) { setGeneratedImageURL("placeholder_error"); return; } // Use a unique error state

            setIsImageGenerating(true);
            setGeneratedImageURL(null);

            const prompt = A breathtaking, realistic, cinematic illustration of the ${currentEra.name} era (${year} million years ago). The image should show the dominant landscape (e.g., Pangea coastline, vast ocean, dense ferns) and the primary life forms (e.g., early reptiles, massive dinosaurs, early mammals). Focus on dramatic lighting and historical accuracy based on the description: "${currentEra.description}".;

            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };
            
            let resultBase64 = null;
            const maxRetries = 3;
            let delay = 1000;

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(
                        https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey},
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        if (data.predictions && data.predictions.length > 0 && data.predictions[0].bytesBase64Encoded) {
                            resultBase64 = data.predictions[0].bytesBase64Encoded;
                            break; 
                        }
                    }

                } catch (error) {
                    console.warn(Image API call failed, retrying in ${delay}ms...);
                }

                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }

            if (resultBase64) {
                const imageUrl = data:image/png;base64,${resultBase64};
                setGeneratedImageURL(imageUrl);
            } else {
                setGeneratedImageURL("placeholder_error"); 
                console.error("Failed to generate image after retries.");
            }

            setIsImageGenerating(false);
          };


          // ---------------------------------------------------------------------------
          // Three.js Logic
          // ---------------------------------------------------------------------------
          const OrbitControls = window.THREE.OrbitControls || THREE.OrbitControls;

          useEffect(() => {
            let interval;
            if (isPlaying) {
              interval = setInterval(() => {
                setYear((prev) => {
                  const next = prev - 1;
                  if (next < 0) {
                    setIsPlaying(false);
                    return 0;
                  }
                  return next;
                });
              }, 50);
            }
            return () => clearInterval(interval);
          }, [isPlaying]);

          useEffect(() => {
            const era = GEOLOGICAL_ERAS.reduce((prev, curr) => {
              return (Math.abs(curr.time - year) < Math.abs(prev.time - year) ? curr : prev);
            });
            setCurrentEra(era);
            setEraHeadline(null);
            setGeneratedImageURL(null);
          }, [year]);

          const generateWorld = () => {
            const landMeshes = [];
            while(globeGroupRef.current.children.length > 0){ 
                globeGroupRef.current.remove(globeGroupRef.current.children[0]); 
            }

            const plateGroups = {};
            Object.keys(PLATES).forEach(key => {
              const group = new THREE.Group();
              group.userData = { plateId: key };
              plateGroups[key] = group;
              globeGroupRef.current.add(group);
            });

            const numPoints = 600; 
            const radius = 6;

            for (let i = 0; i < numPoints; i++) {
              const phi = Math.acos(1 - 2 * (i + 0.5) / numPoints);
              const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);

              const x = radius * Math.sin(phi) * Math.cos(theta);
              const y = radius * Math.sin(phi) * Math.sin(theta);
              const z = radius * Math.cos(phi);
              
              const position = new THREE.Vector3(x, y, z);
              
              const lat = 90 - (Math.acos(y / radius)) * 180 / Math.PI;
              const lon = (Math.atan2(z, x)) * 180 / Math.PI;

              let plateKey = null;
              let isLand = false;

              if (lon > -130 && lon < -60) {
                if (lat > 15) plateKey = 'NA';
                else if (lat > -60) plateKey = 'SA';
              } 
              else if (lon >= -20 && lon < 180 && lat > 0) {
                  if (lon < 40 && lat < 40) plateKey = 'AF'; 
                  else if (lat < 35 && lon > 70 && lon < 100) plateKey = 'IN'; 
                  else plateKey = 'EU';
              }
              else if (lon >= -20 && lon < 60 && lat <= 35 && lat > -40) {
                  plateKey = 'AF';
              }
              else if (lon > 110 && lon < 160 && lat < -10 && lat > -50) {
                  plateKey = 'AU';
              }
              else if (lat < -60) {
                  plateKey = 'AN';
              }

              if (plateKey) {
                  const noise = seededRandom(i);
                  if (noise > 0.2) {
                      isLand = true;
                  }
              }

              if (isLand && plateKey) {
                const geometry = new THREE.CylinderGeometry(0.2, 0.15, 0.4, 6);
                geometry.rotateX(Math.PI / 2);
                const material = new THREE.MeshPhongMaterial({ 
                    color: PLATES[plateKey].color,
                    flatShading: true
                });
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.copy(position);
                mesh.lookAt(0, 0, 0);
                
                plateGroups[plateKey].add(mesh);
                landMeshes.push(mesh);
              }
            }
            landMeshesRef.current = landMeshes;
          };

          useEffect(() => {
            if (!mountRef.current) return;

            const scene = new THREE.Scene();
            scene.background = new THREE.Color('#0f172a'); 
            const starGeometry = new THREE.BufferGeometry();
            const starCount = 1000;
            const starPos = new Float32Array(starCount * 3);
            for(let i=0; i<starCount*3; i++) {
              starPos[i] = (Math.random() - 0.5) * 100;
            }
            starGeometry.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
            const starMaterial = new THREE.PointsMaterial({color: 0xffffff, size: 0.1});
            const stars = new THREE.Points(starGeometry, starMaterial);
            scene.add(stars);

            sceneRef.current = scene;

            const camera = new THREE.PerspectiveCamera(45, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 1000);
            camera.position.z = 22;
            camera.position.y = 10;
            cameraRef.current = camera;

            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            mountRef.current.appendChild(renderer.domElement);
            rendererRef.current = renderer;

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 12;
            controls.maxDistance = 40;
            controlsRef.current = controls;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(50, 20, 30);
            scene.add(dirLight);

            const oceanGeometry = new THREE.IcosahedronGeometry(5.8, 2); 
            const oceanMaterial = new THREE.MeshPhongMaterial({ 
              color: 0x1e3a8a, 
              specular: 0x111111,
              shininess: 10
            });
            const ocean = new THREE.Mesh(oceanGeometry, oceanMaterial);
            scene.add(ocean);

            const globeGroup = new THREE.Group();
            scene.add(globeGroup);
            globeGroupRef.current = globeGroup;

            generateWorld();

            setLoading(false);

            const handleResize = () => {
              if (!mountRef.current || !cameraRef.current || !rendererRef.current) return;
              const width = mountRef.current.clientWidth;
              const height = mountRef.current.clientHeight;
              cameraRef.current.aspect = width / height;
              cameraRef.current.updateProjectionMatrix();
              rendererRef.current.setSize(width, height);
            };
            window.addEventListener('resize', handleResize);

            const animate = () => {
              requestAnimationFrame(animate);
              controls.update();
              
              if (globeGroupRef.current) {
                 globeGroupRef.current.rotation.y += 0.0005;
                 ocean.rotation.y += 0.0005;
              }

              renderer.render(scene, camera);
            };
            animate();

            return () => {
              window.removeEventListener('resize', handleResize);
              if (mountRef.current && renderer.domElement) {
                mountRef.current.removeChild(renderer.domElement);
              }
              landMeshesRef.current.forEach(obj => {
                if (obj.geometry) obj.geometry.dispose();
                if (obj.material) obj.material.dispose();
              });
            };
          }, []);

          useEffect(() => {
            if (!globeGroupRef.current) return;
            const t = (250 - year) / 250; 

            Object.keys(PLATES).forEach(key => {
              const data = PLATES[key];
              const group = globeGroupRef.current.children.find(g => g.userData.plateId === key);
              
              if (group) {
                const startQuaternion = new THREE.Quaternion();
                const endQuaternion = new THREE.Quaternion();

                const axis = data.axis.clone().normalize();
                let angle = 0;

                switch (key) {
                    case 'NA': angle = -0.5; break; 
                    case 'SA': angle = -0.6; break; 
                    case 'AF': angle = 0.1; break;  
                    case 'EU': angle = -0.2; break; 
                    case 'IN': angle = -1.2; break; 
                    case 'AU': angle = -0.8; break; 
                    case 'AN': angle = 0.1; break;  
                    default: angle = 0;
                }
                
                startQuaternion.setFromAxisAngle(axis, angle);
                
                const currentQ = new THREE.Quaternion();
                currentQ.slerpQuaternions(startQuaternion, endQuaternion, t);
                
                group.setRotationFromQuaternion(currentQ);
              }
            });
          }, [year]);


          return (
            <div className="relative w-full h-screen bg-slate-900 overflow-hidden font-sans text-slate-100">
              {/* 3D Canvas Container */}
              <div ref={mountRef} className="absolute inset-0 z-0 cursor-move" />

              {/* Loading Screen */}
              {loading && (
                <div className="absolute inset-0 flex items-center justify-center bg-slate-900 z-50">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
                </div>
              )}

              {/* Header Overlay */}
              <div className="absolute top-0 left-0 w-full p-6 pointer-events-none flex justify-between items-start bg-gradient-to-b from-slate-900/80 to-transparent z-10">
                <div>
                  <h1 className="text-3xl font-bold flex items-center gap-2 text-blue-400 drop-shadow-lg">
                    <Globe className="w-8 h-8" /> GeoDrift
                  </h1>
                  <p className="text-sm text-slate-400 mt-1">3D æ¿å¡Šæ§‹é€ æ¼”è®Šæ¨¡æ“¬å™¨</p>
                </div>
                
                <div className="bg-slate-800/90 backdrop-blur-md p-4 rounded-xl shadow-lg border border-slate-700 pointer-events-auto max-w-xs hidden md:block">
                    <div className="flex items-center gap-2 mb-2 text-blue-300">
                        <Info size={16} /> 
                        <span className="font-bold text-sm">åœ°è³ªå°ç™¾ç§‘</span>
                    </div>
                    <p className="text-xs leading-relaxed text-slate-300">
                        æ‹–å‹•ä¸‹æ–¹æ™‚é–“è»¸ï¼Œè§€å¯Ÿåœ°çƒå¦‚ä½•å¾ç›¤å¤å¤§é™¸æ¼”è®Šè‡³ä»Šã€‚é»æ“Šå³ä¸‹è§’çš„ã€Œâœ¨ã€æŒ‰éˆ•å¬å–š AI å°éŠï¼
                    </p>
                </div>
              </div>

              {/* AI Floating Action Button */}
              <div className="absolute bottom-48 right-6 z-20 pointer-events-auto">
                 <button 
                    onClick={() => setChatOpen(!chatOpen)}
                    className={`p-4 rounded-full shadow-xl transition-all duration-300 flex items-center gap-2 ${
                        chatOpen ? 'bg-slate-700 text-white rotate-90' : 'bg-gradient-to-r from-purple-600 to-blue-600 text-white hover:scale-110 animate-bounce-slow'
                    }`}
                 >
                    {chatOpen ? <X size={24} /> : <Sparkles size={24} />}
                 </button>
              </div>

              {/* AI Chat Interface */}
              <div className={`absolute bottom-6 right-6 w-80 md:w-96 bg-slate-900/95 backdrop-blur-xl border border-slate-700 rounded-2xl shadow-2xl z-20 pointer-events-auto flex flex-col transition-all duration-500 ease-in-out origin-bottom-right ${
                  chatOpen ? 'opacity-100 scale-100 translate-y-0 h-[500px]' : 'opacity-0 scale-90 translate-y-10 h-0 pointer-events-none overflow-hidden'
              }`}>
                {/* Chat Header */}
                <div className="p-4 border-b border-slate-700 bg-slate-800/50 flex items-center justify-between rounded-t-2xl">
                    <div className="flex items-center gap-2">
                        <Sparkles className="text-yellow-400" size={18} />
                        <h3 className="font-bold text-slate-100">AI æ™‚ç©ºå°éŠ</h3>
                    </div>
                    <span className="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded-full border border-blue-700">
                        {year} Ma â€¢ {currentEra.name.split(' ')[0]}
                    </span>
                </div>

                {/* Chat Messages */}
                <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                    {messages.map((msg, idx) => (
                        <div key={idx} className={flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}}>
                            <div className={`max-w-[85%] rounded-2xl px-4 py-3 text-sm leading-relaxed ${
                                msg.role === 'user' 
                                ? 'bg-blue-600 text-white rounded-tr-none' 
                                : 'bg-slate-700 text-slate-200 rounded-tl-none border border-slate-600'
                            }`}>
                                {msg.text}
                            </div>
                        </div>
                    ))}
                    {isAiLoading && (
                        <div className="flex justify-start">
                            <div className="bg-slate-700 rounded-2xl rounded-tl-none px-4 py-3 flex gap-1 items-center">
                                <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                                <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-75"></span>
                                <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-150"></span>
                            </div>
                        </div>
                    )}
                </div>

                {/* Quick Actions */}
                <div className="p-2 px-4 flex gap-2 overflow-x-auto custom-scrollbar pb-2">
                    <button onClick={() => handleQuickAction('animals')} className="flex-shrink-0 text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 text-blue-300 px-3 py-1.5 rounded-full transition-colors">ğŸ¦• æé¾/ç”Ÿç‰©</button>
                    <button onClick={() => handleQuickAction('climate')} className="flex-shrink-0 text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 text-yellow-300 px-3 py-1.5 rounded-full transition-colors">â˜€ï¸ æ°£å€™</button>
                    <button onClick={() => handleQuickAction('funfact')} className="flex-shrink-0 text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 text-purple-300 px-3 py-1.5 rounded-full transition-colors">âœ¨ å†·çŸ¥è­˜</button>
                </div>

                {/* Chat Input */}
                <div className="p-3 border-t border-slate-700 bg-slate-800/50 rounded-b-2xl flex gap-2">
                    <input 
                        type="text" 
                        value={aiInput}
                        onChange={(e) => setAiInput(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && callGemini(aiInput)}
                        placeholder="é—œæ–¼é€™å€‹æ™‚ä»£çš„ä»»ä½•å•é¡Œ..."
                        className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-slate-500"
                    />
                    <button 
                        onClick={() => callGemini(aiInput)}
                        disabled={!aiInput.trim() || isAiLoading}
                        className="bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white p-2 rounded-xl transition-colors"
                    >
                        <Send size={18} />
                    </button>
                </div>
              </div>

              {/* Bottom Control Panel */}
              <div className="absolute bottom-0 left-0 w-full pointer-events-none z-10">
                <div className="w-full max-w-6xl mx-auto bg-slate-800/90 backdrop-blur-xl rounded-t-2xl p-6 shadow-2xl border-t border-slate-700 pointer-events-auto">
                    
                    {/* Top Row: Era Name, Time, and Main Controls */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="text-center md:text-left">
                            <div className="text-xs font-bold text-blue-400 tracking-widest uppercase mb-1">ç•¶å‰ç´€å…ƒ</div>
                            <h2 className="text-2xl font-bold text-white">{currentEra.name}</h2>
                        </div>
                        
                        <div className="flex-1 min-w-[200px] flex flex-col items-center justify-center">
                             <div className="text-4xl font-mono font-bold text-yellow-400">
                                {year} <span className="text-lg text-slate-400">Ma (ç™¾è¬å¹´å‰)</span>
                             </div>
                             {/* AI Actions Group */}
                             <div className="flex gap-3 mt-3">
                                 {/* æ™‚ä»£é ­æ¢ç”Ÿæˆå™¨ */}
                                 <button
                                    onClick={generateEraHeadline}
                                    disabled={isHeadlineLoading || isPlaying || isImageGenerating}
                                    className="text-xs flex items-center gap-1 bg-purple-700 hover:bg-purple-600 disabled:bg-slate-700 disabled:text-slate-500 text-white px-3 py-1.5 rounded-full transition-colors font-semibold"
                                 >
                                    {isHeadlineLoading ? (
                                        <>
                                            <RotateCcw className="animate-spin" size={12} /> é ­æ¢ä¸­...
                                        </>
                                    ) : (
                                        <>
                                            <Sparkles size={12} /> æ™‚ä»£é ­æ¢
                                        </>
                                    )}
                                 </button>
                                 {/* æ™‚ä»£å½±åƒç”Ÿæˆå™¨ (åŠŸèƒ½ä¸‰) */}
                                 <button
                                    onClick={generateEraImage}
                                    disabled={isImageGenerating || isPlaying || isHeadlineLoading}
                                    className="text-xs flex items-center gap-1 bg-green-600 hover:bg-green-500 disabled:bg-slate-700 disabled:text-slate-500 text-white px-3 py-1.5 rounded-full transition-colors font-semibold"
                                 >
                                    {isImageGenerating ? (
                                        <>
                                            <RotateCcw className="animate-spin" size={12} /> ç¹ªåœ–ä¸­...
                                        </>
                                    ) : (
                                        <>
                                            <Sparkles size={12} /> ç”Ÿæˆå½±åƒ
                                        </>
                                    )}
                                 </button>
                             </div>
                        </div>

                        <div className="flex gap-3">
                            <button 
                                onClick={() => setIsPlaying(!isPlaying)}
                                className={`flex items-center gap-2 px-6 py-2 rounded-full font-bold transition-all ${
                                    isPlaying ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'
                                }`}
                            >
                                {isPlaying ? <><Pause size={18} /> æš«åœ</> : <><Play size={18} /> æ’­æ”¾æ¼”è®Š</>}
                            </button>
                            <button 
                                onClick={() => {setYear(250); setIsPlaying(false);}}
                                className="p-2 rounded-full bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"
                                title="é‡ç½®"
                            >
                                <RotateCcw size={18} />
                            </button>
                        </div>
                    </div>

                    {/* åŠŸèƒ½äºŒçš„é¡¯ç¤ºå€åŸŸï¼šæ™‚ä»£é ­æ¢ */}
                    {eraHeadline && (
                        <div className="bg-purple-900/50 rounded-lg p-4 mb-4 border border-purple-700 shadow-md">
                            <h3 className="text-lg font-extrabold text-purple-300 mb-1 flex items-center gap-2">
                                <MessageSquare size={18} /> {eraHeadline.headline}
                            </h3>
                            <p className="text-sm text-purple-200 leading-relaxed">
                                {eraHeadline.summary}
                            </p>
                        </div>
                    )}
                    
                    {/* åŠŸèƒ½ä¸‰çš„é¡¯ç¤ºå€åŸŸï¼šæ™‚ä»£å½±åƒ */}
                    {generatedImageURL && generatedImageURL !== "placeholder_error" && (
                        <div className="mb-4 flex justify-center p-2">
                            <img 
                                src={generatedImageURL} 
                                alt={${currentEra.name} æ™‚ä»£å½±åƒ} 
                                className="w-full max-w-lg h-auto rounded-lg shadow-xl border-4 border-slate-700 object-cover" 
                            />
                        </div>
                    )}
                    {generatedImageURL === "placeholder_error" && (
                        <div className="mb-4 flex justify-center p-2">
                            <div className="w-full max-w-lg h-64 bg-red-900/50 border-2 border-red-500 rounded-lg flex items-center justify-center text-red-200">
                                å½±åƒç”Ÿæˆå¤±æ•—ï¼šè«‹æª¢æŸ¥ API Key æ˜¯å¦æœ‰æ•ˆã€‚
                            </div>
                        </div>
                    )}

                    {/* Description Text */}
                    <div className="bg-slate-900/50 rounded-lg p-3 mb-4 text-sm text-slate-300 border-l-4 border-blue-500">
                        {currentEra.description}
                    </div>

                    {/* Slider Control */}
                    <div className="relative pt-1">
                        <input 
                            type="range" 
                            min="0" 
                            max="250" 
                            step="1"
                            value={year}
                            onChange={(e) => {
                                setYear(parseInt(e.target.value));
                                setIsPlaying(false);
                            }}
                            className="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400 transition-all"
                            style={{direction: 'rtl'}}
                        />
                        <div className="flex justify-between text-xs text-slate-500 mt-2 font-mono">
                            <span>250 Ma (ç›¤å¤å¤§é™¸)</span>
                            <span>150 Ma</span>
                            <span>65 Ma</span>
                            <span>0 Ma (ç¾ä»£)</span>
                        </div>
                    </div>

                </div>
              </div>

            </div>
          );
        }

        // æ¸²æŸ“ä¸»å…ƒä»¶
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('root');
            if (container) {
                ReactDOM.createRoot(container).render(<App />);
            }
        });
    </script>
</body>
</html>
