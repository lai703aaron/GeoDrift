import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Play, Pause, Info, Globe, RotateCcw, Sparkles, MessageSquare, X, Send } from 'lucide-react';
import * as THREE from 'three';
// ç¢ºä¿å°å…¥è·¯å¾‘åŒ…å« .js å‰¯æª”åä»¥ç¬¦åˆç·¨è­¯ç’°å¢ƒ
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

// -----------------------------------------------------------------------------
// API è¨­å®š
// -----------------------------------------------------------------------------
const apiKey = "AIzaSyDdVVMuxFaQiTHskDWafpYkOWrSma-v_Q0"; // API Key æœƒç”±ç³»çµ±ç’°å¢ƒè‡ªå‹•æ³¨å…¥ï¼Œç„¡éœ€æ‰‹å‹•å¡«å¯«

// -----------------------------------------------------------------------------
// æ•¸æ“šèˆ‡å¸¸æ•¸å®šç¾©
// -----------------------------------------------------------------------------

// åœ°è³ªå¹´ä»£æ•¸æ“š
const GEOLOGICAL_ERAS = [
  { name: "äºŒç–Šç´€ (Permian)", time: 250, description: "ç›¤å¤å¤§é™¸ (Pangea) å½¢æˆï¼Œæ‰€æœ‰é™¸å¡Šèšåˆåœ¨ä¸€èµ·ã€‚æ°£å€™ä¹¾ç‡¥ï¼Œçˆ¬è¡Œå‹•ç‰©é–‹å§‹ç¹è¡ã€‚" },
  { name: "ä¸‰ç–Šç´€ (Triassic)", time: 200, description: "ç›¤å¤å¤§é™¸é–‹å§‹åˆ†è£‚ã€‚æé¾å‡ºç¾ï¼Œæœ€æ—©çš„å“ºä¹³å‹•ç‰©èª•ç”Ÿã€‚" },
  { name: "ä¾ç¾…ç´€ (Jurassic)", time: 150, description: "å‹äºå¤§é™¸èˆ‡å²¡ç“¦ç´å¤§é™¸åˆ†é›¢ã€‚æé¾çµ±æ²»åœ°çƒï¼Œæ°£å€™æº«æš–æ¿•æ½¤ã€‚" },
  { name: "ç™½å Šç´€ (Cretaceous)", time: 100, description: "å¤§é™¸æ¿å¡Šé€²ä¸€æ­¥åˆ†é›¢ï¼Œå¤§è¥¿æ´‹å½¢æˆã€‚é–‹èŠ±æ¤ç‰©å‡ºç¾ã€‚" },
  { name: "å¤è¿‘ç´€ (Paleogene)", time: 50, description: "æé¾æ»…çµ•å¾Œï¼Œå“ºä¹³å‹•ç‰©å¿«é€Ÿæ¼”åŒ–ã€‚å°åº¦æ¿å¡Šæ’æ“Šæ­äºæ¿å¡Šï¼Œå–œé¦¬é¦¬æ‹‰é›…å±±å‡èµ·ã€‚" },
  { name: "ç¾ä»£ (Present)", time: 0, description: "ç•¶å‰çš„åœ°è²Œã€‚ä¸ƒå¤§æ´²äº”å¤§æ´‹å®šå‹ï¼Œäººé¡æ–‡æ˜ç™¼å±•ã€‚" },
];

// æ¿å¡Šå®šç¾© (ç°¡åŒ–æ¨¡æ“¬æ•¸æ“š)
const PLATES = {
  NA: { id: 1, color: '#4ade80', axis: new THREE.Vector3(0, 1, 0), speed: 0.5, name: 'åŒ—ç¾æ¿å¡Š' },
  SA: { id: 2, color: '#22c55e', axis: new THREE.Vector3(0.2, 1, 0), speed: 0.4, name: 'å—ç¾æ¿å¡Š' },
  EU: { id: 3, color: '#16a34a', axis: new THREE.Vector3(0, 1, 0.1), speed: 0.2, name: 'æ­äºæ¿å¡Š' },
  AF: { id: 4, color: '#15803d', axis: new THREE.Vector3(0.1, 1, -0.1), speed: 0.3, name: 'éæ´²æ¿å¡Š' },
  AU: { id: 5, color: '#86efac', axis: new THREE.Vector3(-0.5, 1, 0), speed: 0.8, name: 'æ¾³æ´²æ¿å¡Š' },
  AN: { id: 6, color: '#f0fdf4', axis: new THREE.Vector3(1, 0, 0), speed: 0.1, name: 'å—æ¥µæ¿å¡Š' },
  IN: { id: 7, color: '#bbf7d0', axis: new THREE.Vector3(-1, 0.5, 0), speed: 1.5, name: 'å°åº¦æ¿å¡Š' },
};

// -----------------------------------------------------------------------------
// è¼”åŠ©å‡½æ•¸
// -----------------------------------------------------------------------------

// å½éš¨æ©Ÿæ•¸ç”Ÿæˆå™¨ (ç¢ºä¿æ¯æ¬¡åœ°å½¢ç”Ÿæˆä¸€è‡´)
const seededRandom = (seed) => {
  const x = Math.sin(seed++) * 10000;
  return x - Math.floor(x);
};

// -----------------------------------------------------------------------------
// ä¸»æ‡‰ç”¨çµ„ä»¶
// -----------------------------------------------------------------------------

export default function GeoDriftApp() {
  const mountRef = useRef(null);
  const [loading, setLoading] = useState(true);
  const [year, setYear] = useState(250); // å–®ä½ï¼šç™¾è¬å¹´å‰ (Ma)
  const [isPlaying, setIsPlaying] = useState(false);
  const [currentEra, setCurrentEra] = useState(GEOLOGICAL_ERAS[0]);

  // AI Chat State (åŠŸèƒ½ä¸€ï¼šæ™‚ç©ºå°éŠ)
  const [chatOpen, setChatOpen] = useState(false);
  const [messages, setMessages] = useState([
    { role: 'system', text: "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ AI æ™‚ç©ºå°éŠã€‚ç§»å‹•æ™‚é–“è»¸ï¼Œéš¨æ™‚å•æˆ‘é—œæ–¼é‚£å€‹æ™‚ä»£çš„å•é¡Œï¼" }
  ]);
  const [aiInput, setAiInput] = useState("");
  const [isAiLoading, setIsAiLoading] = useState(false);

  // AI Headline State (åŠŸèƒ½äºŒï¼šæ™‚ä»£é ­æ¢)
  const [eraHeadline, setEraHeadline] = useState(null);
  const [isHeadlineLoading, setIsHeadlineLoading] = useState(false);

  // AI Image State (åŠŸèƒ½ä¸‰ï¼šæ™‚ä»£å½±åƒç”Ÿæˆ)
  const [generatedImageURL, setGeneratedImageURL] = useState(null);
  const [isImageGenerating, setIsImageGenerating] = useState(false);

  // ç”¨æ–¼ Three.js çš„ Refs
  const sceneRef = useRef(null);
  const cameraRef = useRef(null);
  const rendererRef = useRef(null);
  const controlsRef = useRef(null);
  const globeGroupRef = useRef(null);
  const landMeshesRef = useRef([]); 

  // ---------------------------------------------------------------------------
  // Gemini API Integration - æ™‚ç©ºå°éŠèŠå¤© (åŠŸèƒ½ä¸€)
  // ---------------------------------------------------------------------------
  const callGemini = async (userPrompt) => {
    if (!userPrompt.trim()) return;

    // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
    const newMessages = [...messages, { role: 'user', text: userPrompt }];
    setMessages(newMessages);
    setAiInput("");
    setIsAiLoading(true);

    // å»ºæ§‹åŒ…å«ç•¶å‰å¹´ä»£èƒŒæ™¯çš„ Prompt
    const systemPrompt = `
      You are an enthusiastic AI Time-Travel Guide and Geologist.
      The user is currently viewing a 3D simulation of Earth at ${year} million years ago (Era: ${currentEra.name}).
      
      Context:
      - Current Time: ${year} Ma (Million Years Ago)
      - Geological Era: ${currentEra.name}
      - Description: ${currentEra.description}
      
      Your Goal:
      Answer the user's question specifically about this time period. 
      Keep your answer concise (under 100 words), educational, and fun.
      If the user asks about the future or past relative to this time, explain based on your geological knowledge.
      Use emojis âœ¨ğŸ¦•ğŸŒ‹ sparingly to make it engaging.
      Language: Traditional Chinese (ç¹é«”ä¸­æ–‡).
    `;

    try {
      const response = await fetch(
        https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey},
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: userPrompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
          }),
        }
      );

      if (!response.ok) throw new Error('API request failed');

      const data = await response.json();
      const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "æŠ±æ­‰ï¼Œæ™‚ç©ºé€šè¨Šä¼¼ä¹å—åˆ°å¹²æ“¾ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";

      setMessages([...newMessages, { role: 'assistant', text: aiResponse }]);

    } catch (error) {
      console.error("Gemini API Error:", error);
      setMessages([...newMessages, { role: 'assistant', text: "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚" }]);
    } finally {
      setIsAiLoading(false);
    }
  };

  const handleQuickAction = (action) => {
    let prompt = "";
    switch (action) {
        case 'animals': prompt = "é€™å€‹æ™‚ä»£æœ‰ä»€éº¼ä»£è¡¨æ€§çš„å‹•ç‰©ï¼Ÿ"; break;
        case 'climate': prompt = "ç¾åœ¨çš„æ°£å€™æ„Ÿè¦ºå¦‚ä½•ï¼Ÿé©åˆäººé¡ç”Ÿå­˜å—ï¼Ÿ"; break;
        case 'continents': prompt = "ç¾åœ¨çš„å¤§é™¸æ¿å¡Šé•·ä»€éº¼æ¨£å­ï¼Ÿ"; break;
        default: prompt = "å‘Šè¨´æˆ‘ä¸€å€‹é—œæ–¼é€™å€‹æ™‚ä»£çš„æœ‰è¶£å†·çŸ¥è­˜ï¼";
    }
    callGemini(prompt);
  };
  
  // ---------------------------------------------------------------------------
  // Gemini API Integration - æ™‚ä»£é ­æ¢ç”Ÿæˆå™¨ (åŠŸèƒ½äºŒ)
  // ---------------------------------------------------------------------------
  const generateEraHeadline = async () => {
    setIsHeadlineLoading(true);
    setEraHeadline(null); // æ¸…é™¤èˆŠé ­æ¢

    const userPrompt = `Generate a captivating, single-sentence headline (max 12 Traditional Chinese characters) and a short, dramatic summary (max 30 Traditional Chinese characters) for the year ${year} Ma. Focus on the most significant event in the current era (${currentEra.name}) and its position in the timeline. 
    Format the output STRICTLY as: "Headline | Summary". If the current year is the exact start/end of an era (e.g., 250Ma or 0Ma), highlight that transition.`;

    const systemPrompt = `
      You are an AI Historical News Reporter. The user wants a dramatic summary of the current geological period.
      Context: ${year} Ma (${currentEra.name}). Description: ${currentEra.description}
      Output MUST be in the exact format: "Headline | Summary". Use Traditional Chinese (ç¹é«”ä¸­æ–‡).
    `;

    let result = null;
    const maxRetries = 3;
    let delay = 1000;

    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(
                https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey},
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    }),
                }
            );

            if (response.ok) {
                const data = await response.json();
                result = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (result) break; // æˆåŠŸå–å¾—çµæœ
            }

        } catch (error) {
            console.warn(Headline API call failed, retrying in ${delay}ms...);
        }

        if (i < maxRetries - 1) {
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // æŒ‡æ•¸é€€é¿
        }
    }

    if (result) {
        const parts = result.split('|').map(s => s.trim());
        const headline = parts[0] || "é‡å¤§äº‹ä»¶ç™¼ç”Ÿï¼";
        const summary = parts[1] || "AIç”Ÿæˆæ‘˜è¦å¤±æ•—ã€‚è«‹é‡è©¦ã€‚";
        setEraHeadline({ headline, summary });
    } else {
        setEraHeadline({ headline: "æ™‚ç©ºè¨Šè™Ÿä¸­æ–·", summary: "ç„¡æ³•å–å¾—è©²å¹´ä»£çš„æ­·å²é ­æ¢ã€‚" });
    }
    
    setIsHeadlineLoading(false);
  };
  
  // ---------------------------------------------------------------------------
  // Gemini API Integration - æ™‚ä»£å½±åƒç”Ÿæˆå™¨ (åŠŸèƒ½ä¸‰)
  // ---------------------------------------------------------------------------
  const generateEraImage = async () => {
    setIsImageGenerating(true);
    setGeneratedImageURL(null);

    // æç¤ºè©ä½¿ç”¨è‹±æ–‡ä»¥ç²å¾—æœ€ä½³çš„ Imagen ç”Ÿæˆæ•ˆæœ
    const prompt = A breathtaking, realistic, cinematic illustration of the ${currentEra.name} era (${year} million years ago). The image should show the dominant landscape (e.g., Pangea coastline, vast ocean, dense ferns) and the primary life forms (e.g., early reptiles, massive dinosaurs, early mammals). Focus on dramatic lighting and historical accuracy based on the description: "${currentEra.description}".;

    const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };
    
    let resultBase64 = null;
    const maxRetries = 3;
    let delay = 1000;

    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(
                https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey},
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }
            );

            if (response.ok) {
                const data = await response.json();
                if (data.predictions && data.predictions.length > 0 && data.predictions[0].bytesBase64Encoded) {
                    resultBase64 = data.predictions[0].bytesBase64Encoded;
                    break; // æˆåŠŸ
                }
            }

        } catch (error) {
            console.warn(Image API call failed, retrying in ${delay}ms...);
        }

        if (i < maxRetries - 1) {
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2; // æŒ‡æ•¸é€€é¿
        }
    }

    if (resultBase64) {
        const imageUrl = data:image/png;base64,${resultBase64};
        setGeneratedImageURL(imageUrl);
    } else {
        console.error("Failed to generate image after retries.");
    }

    setIsImageGenerating(false);
  };


  // ---------------------------------------------------------------------------
  // Three.js Logic
  // ---------------------------------------------------------------------------

  // æ’­æ”¾å¾ªç’°é‚è¼¯
  useEffect(() => {
    let interval;
    if (isPlaying) {
      interval = setInterval(() => {
        setYear((prev) => {
          const next = prev - 1;
          if (next < 0) {
            setIsPlaying(false);
            return 0;
          }
          return next;
        });
      }, 50); // æ¯ 50ms æ¸›å°‘ 1 Ma
    }
    return () => clearInterval(interval);
  }, [isPlaying]);

  // æ›´æ–°ç•¶å‰æ™‚ä»£è³‡è¨Š (ä¸¦æ¸…é™¤ AI ç›¸é—œå…§å®¹)
  useEffect(() => {
    // æ‰¾åˆ°æœ€æ¥è¿‘çš„æ™‚ä»£
    const era = GEOLOGICAL_ERAS.reduce((prev, curr) => {
      return (Math.abs(curr.time - year) < Math.abs(prev.time - year) ? curr : prev);
    });
    setCurrentEra(era);
    // ç•¶å¹´ä»½æ”¹è®Šæ™‚æ¸…é™¤é ­æ¢å’Œå½±åƒ
    setEraHeadline(null);
    setGeneratedImageURL(null);
  }, [year]);

  // åˆå§‹åŒ– Three.js å ´æ™¯
  useEffect(() => {
    if (!mountRef.current) return;

    // 1. Setup Scene
    const scene = new THREE.Scene();
    scene.background = new THREE.Color('#0f172a'); 
    // æ·»åŠ ä¸€äº›æ˜Ÿæ˜ŸèƒŒæ™¯
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 1000;
    const starPos = new Float32Array(starCount * 3);
    for(let i=0; i<starCount*3; i++) {
      starPos[i] = (Math.random() - 0.5) * 100;
    }
    starGeometry.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
    const starMaterial = new THREE.PointsMaterial({color: 0xffffff, size: 0.1});
    const stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);

    sceneRef.current = scene;

    // 2. Setup Camera
    const camera = new THREE.PerspectiveCamera(45, mountRef.current.clientWidth / mountRef.current.clientHeight, 0.1, 1000);
    camera.position.z = 22;
    camera.position.y = 10;
    cameraRef.current = camera;

    // 3. Setup Renderer
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(mountRef.current.clientWidth, mountRef.current.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    mountRef.current.appendChild(renderer.domElement);
    rendererRef.current = renderer;

    // 4. Controls
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 12;
    controls.maxDistance = 40;
    controlsRef.current = controls;

    // 5. Lighting
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(50, 20, 30);
    scene.add(dirLight);

    // 6. æ§‹å»ºåœ°çƒ (æ ¸å¿ƒæµ·æ´‹)
    const oceanGeometry = new THREE.IcosahedronGeometry(5.8, 2); 
    const oceanMaterial = new THREE.MeshPhongMaterial({ 
      color: 0x1e3a8a, 
      specular: 0x111111,
      shininess: 10
    });
    const ocean = new THREE.Mesh(oceanGeometry, oceanMaterial);
    scene.add(ocean);

    // 7. æ§‹å»ºé™¸åœ° (Procedural Generation)
    const globeGroup = new THREE.Group();
    scene.add(globeGroup);
    globeGroupRef.current = globeGroup;

    generateWorld();

    setLoading(false);

    // Resize Handler
    const handleResize = () => {
      if (!mountRef.current || !cameraRef.current || !rendererRef.current) return;
      const width = mountRef.current.clientWidth;
      const height = mountRef.current.clientHeight;
      cameraRef.current.aspect = width / height;
      cameraRef.current.updateProjectionMatrix();
      rendererRef.current.setSize(width, height);
    };
    window.addEventListener('resize', handleResize);

    // Animation Loop
    const animate = () => {
      requestAnimationFrame(animate);
      controls.update();
      
      // ç·©æ…¢è‡ªè½‰
      if (globeGroupRef.current) {
         globeGroupRef.current.rotation.y += 0.0005;
         ocean.rotation.y += 0.0005;
      }

      renderer.render(scene, camera);
    };
    animate();

    return () => {
      window.removeEventListener('resize', handleResize);
      if (mountRef.current && renderer.domElement) {
        mountRef.current.removeChild(renderer.domElement);
      }
      // Clean up meshes
      landMeshesRef.current.forEach(obj => {
        if (obj.geometry) obj.geometry.dispose();
        if (obj.material) obj.material.dispose();
      });
    };
  }, []);

  // ç”Ÿæˆä¸–ç•Œå‡½æ•¸ (ä½å¤šé‚Šå½¢å…­è§’æŸ±)
  const generateWorld = () => {
    const landMeshes = [];
    // æ¸…ç©ºèˆŠçš„
    while(globeGroupRef.current.children.length > 0){ 
        globeGroupRef.current.remove(globeGroupRef.current.children[0]); 
    }

    // ç‚ºæ¯å€‹æ¿å¡Šå‰µå»ºä¸€å€‹ Group
    const plateGroups = {};
    Object.keys(PLATES).forEach(key => {
      const group = new THREE.Group();
      group.userData = { plateId: key };
      plateGroups[key] = group;
      globeGroupRef.current.add(group);
    });

    // ä½¿ç”¨ Fibonacci Sphere ç®—æ³•åˆ†ä½ˆé»
    const numPoints = 600; 
    const radius = 6;

    for (let i = 0; i < numPoints; i++) {
      const phi = Math.acos(1 - 2 * (i + 0.5) / numPoints);
      const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);

      const x = radius * Math.sin(phi) * Math.cos(theta);
      const y = radius * Math.sin(phi) * Math.sin(theta);
      const z = radius * Math.cos(phi);
      
      const position = new THREE.Vector3(x, y, z);
      
      // è¨ˆç®—ç¶“ç·¯åº¦
      const lat = 90 - (Math.acos(y / radius)) * 180 / Math.PI;
      const lon = (Math.atan2(z, x)) * 180 / Math.PI;

      let plateKey = null;
      let isLand = false;

      // æ ¹æ“šç¾ä»£åœ°åœ–çš„å¤§è‡´åˆ†ä½ˆåˆ†é…æ¿å¡Šæ­¸å±¬
      if (lon > -130 && lon < -60) {
        if (lat > 15) plateKey = 'NA';
        else if (lat > -60) plateKey = 'SA';
      } 
      else if (lon >= -20 && lon < 180 && lat > 0) {
          if (lon < 40 && lat < 40) plateKey = 'AF'; 
          else if (lat < 35 && lon > 70 && lon < 100) plateKey = 'IN'; 
          else plateKey = 'EU';
      }
      else if (lon >= -20 && lon < 60 && lat <= 35 && lat > -40) {
          plateKey = 'AF';
      }
      else if (lon > 110 && lon < 160 && lat < -10 && lat > -50) {
          plateKey = 'AU';
      }
      else if (lat < -60) {
          plateKey = 'AN';
      }

      // éš¨æ©Ÿå™ªè²ç”Ÿæˆæµ·å²¸ç·š
      if (plateKey) {
          const noise = seededRandom(i);
          if (noise > 0.2) {
              isLand = true;
          }
      }

      if (isLand && plateKey) {
        const geometry = new THREE.CylinderGeometry(0.2, 0.15, 0.4, 6);
        geometry.rotateX(Math.PI / 2);
        const material = new THREE.MeshPhongMaterial({ 
            color: PLATES[plateKey].color,
            flatShading: true
        });
        const mesh = new THREE.Mesh(geometry, material);
        
        mesh.position.copy(position);
        mesh.lookAt(0, 0, 0);
        
        plateGroups[plateKey].add(mesh);
        landMeshes.push(mesh);
      }
    }
    landMeshesRef.current = landMeshes;
  };

  // æ¿å¡Šç§»å‹•æ ¸å¿ƒé‚è¼¯ (Quaternion Interpolation)
  useEffect(() => {
    if (!globeGroupRef.current) return;
    // t: 0 (250Ma) -> 1 (0Ma)
    const t = (250 - year) / 250; 

    Object.keys(PLATES).forEach(key => {
      const data = PLATES[key];
      const group = globeGroupRef.current.children.find(g => g.userData.plateId === key);
      
      if (group) {
        const startQuaternion = new THREE.Quaternion();
        const endQuaternion = new THREE.Quaternion(); // Identity (ç¾ä»£ä½ç½®)

        const axis = data.axis.clone().normalize();
        let angle = 0;

        // è¨­å®šç›¤å¤å¤§é™¸æ™‚æœŸçš„åç§»è§’åº¦
        switch (key) {
            case 'NA': angle = -0.5; break; 
            case 'SA': angle = -0.6; break; 
            case 'AF': angle = 0.1; break;  
            case 'EU': angle = -0.2; break; 
            case 'IN': angle = -1.2; break; 
            case 'AU': angle = -0.8; break; 
            case 'AN': angle = 0.1; break;  
            default: angle = 0;
        }
        
        startQuaternion.setFromAxisAngle(axis, angle);
        
        const currentQ = new THREE.Quaternion();
        currentQ.slerpQuaternions(startQuaternion, endQuaternion, t);
        
        group.setRotationFromQuaternion(currentQ);
      }
    });
  }, [year]);


  return (
    <div className="relative w-full h-screen bg-slate-900 overflow-hidden font-sans text-slate-100">
      {/* 3D Canvas Container */}
      <div ref={mountRef} className="absolute inset-0 z-0 cursor-move" />

      {/* Loading Screen */}
      {loading && (
        <div className="absolute inset-0 flex items-center justify-center bg-slate-900 z-50">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
        </div>
      )}

      {/* Header Overlay */}
      <div className="absolute top-0 left-0 w-full p-6 pointer-events-none flex justify-between items-start bg-gradient-to-b from-slate-900/80 to-transparent z-10">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2 text-blue-400 drop-shadow-lg">
            <Globe className="w-8 h-8" /> GeoDrift
          </h1>
          <p className="text-sm text-slate-400 mt-1">3D æ¿å¡Šæ§‹é€ æ¼”è®Šæ¨¡æ“¬å™¨</p>
        </div>
        
        <div className="bg-slate-800/90 backdrop-blur-md p-4 rounded-xl shadow-lg border border-slate-700 pointer-events-auto max-w-xs hidden md:block">
            <div className="flex items-center gap-2 mb-2 text-blue-300">
                <Info size={16} /> 
                <span className="font-bold text-sm">åœ°è³ªå°ç™¾ç§‘</span>
            </div>
            <p className="text-xs leading-relaxed text-slate-300">
                æ‹–å‹•ä¸‹æ–¹æ™‚é–“è»¸ï¼Œè§€å¯Ÿåœ°çƒå¦‚ä½•å¾ç›¤å¤å¤§é™¸æ¼”è®Šè‡³ä»Šã€‚é»æ“Šå³ä¸‹è§’çš„ã€Œâœ¨ã€æŒ‰éˆ•å¬å–š AI å°éŠï¼
            </p>
        </div>
      </div>

      {/* AI Floating Action Button (ä½ç½®å¾ bottom-36 èª¿æ•´åˆ° bottom-48) */}
      <div className="absolute bottom-48 right-6 z-20 pointer-events-auto">
         <button 
            onClick={() => setChatOpen(!chatOpen)}
            className={`p-4 rounded-full shadow-xl transition-all duration-300 flex items-center gap-2 ${
                chatOpen ? 'bg-slate-700 text-white rotate-90' : 'bg-gradient-to-r from-purple-600 to-blue-600 text-white hover:scale-110 animate-bounce-slow'
            }`}
         >
            {chatOpen ? <X size={24} /> : <Sparkles size={24} />}
         </button>
      </div>

      {/* AI Chat Interface */}
      <div className={`absolute bottom-6 right-6 w-80 md:w-96 bg-slate-900/95 backdrop-blur-xl border border-slate-700 rounded-2xl shadow-2xl z-20 pointer-events-auto flex flex-col transition-all duration-500 ease-in-out origin-bottom-right ${
          chatOpen ? 'opacity-100 scale-100 translate-y-0 h-[500px]' : 'opacity-0 scale-90 translate-y-10 h-0 pointer-events-none overflow-hidden'
      }`}>
        {/* Chat Header */}
        <div className="p-4 border-b border-slate-700 bg-slate-800/50 flex items-center justify-between rounded-t-2xl">
            <div className="flex items-center gap-2">
                <Sparkles className="text-yellow-400" size={18} />
                <h3 className="font-bold text-slate-100">AI æ™‚ç©ºå°éŠ</h3>
            </div>
            <span className="text-xs bg-blue-900 text-blue-200 px-2 py-1 rounded-full border border-blue-700">
                {year} Ma â€¢ {currentEra.name.split(' ')[0]}
            </span>
        </div>

        {/* Chat Messages */}
        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
            {messages.map((msg, idx) => (
                <div key={idx} className={flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}}>
                    <div className={`max-w-[85%] rounded-2xl px-4 py-3 text-sm leading-relaxed ${
                        msg.role === 'user' 
                        ? 'bg-blue-600 text-white rounded-tr-none' 
                        : 'bg-slate-700 text-slate-200 rounded-tl-none border border-slate-600'
                    }`}>
                        {msg.text}
                    </div>
                </div>
            ))}
            {isAiLoading && (
                <div className="flex justify-start">
                    <div className="bg-slate-700 rounded-2xl rounded-tl-none px-4 py-3 flex gap-1 items-center">
                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></span>
                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-75"></span>
                        <span className="w-2 h-2 bg-slate-400 rounded-full animate-bounce delay-150"></span>
                    </div>
                </div>
            )}
        </div>

        {/* Quick Actions */}
        <div className="p-2 px-4 flex gap-2 overflow-x-auto custom-scrollbar pb-2">
            <button onClick={() => handleQuickAction('animals')} className="flex-shrink-0 text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 text-blue-300 px-3 py-1.5 rounded-full transition-colors">ğŸ¦• æé¾/ç”Ÿç‰©</button>
            <button onClick={() => handleQuickAction('climate')} className="flex-shrink-0 text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 text-yellow-300 px-3 py-1.5 rounded-full transition-colors">â˜€ï¸ æ°£å€™</button>
            <button onClick={() => handleQuickAction('funfact')} className="flex-shrink-0 text-xs bg-slate-800 hover:bg-slate-700 border border-slate-600 text-purple-300 px-3 py-1.5 rounded-full transition-colors">âœ¨ å†·çŸ¥è­˜</button>
        </div>

        {/* Chat Input */}
        <div className="p-3 border-t border-slate-700 bg-slate-800/50 rounded-b-2xl flex gap-2">
            <input 
                type="text" 
                value={aiInput}
                onChange={(e) => setAiInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && callGemini(aiInput)}
                placeholder="é—œæ–¼é€™å€‹æ™‚ä»£çš„ä»»ä½•å•é¡Œ..."
                className="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 transition-colors placeholder-slate-500"
            />
            <button 
                onClick={() => callGemini(aiInput)}
                disabled={!aiInput.trim() || isAiLoading}
                className="bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white p-2 rounded-xl transition-colors"
            >
                <Send size={18} />
            </button>
        </div>
      </div>

      {/* Bottom Control Panel (è²¼é½Šåº•éƒ¨ï¼Œä½¿ç”¨åœ“è§’é ‚éƒ¨ï¼Œå¢åŠ æœ€å¤§å¯¬åº¦) */}
      <div className="absolute bottom-0 left-0 w-full pointer-events-none z-10">
        <div className="w-full max-w-6xl mx-auto bg-slate-800/90 backdrop-blur-xl rounded-t-2xl p-6 shadow-2xl border-t border-slate-700 pointer-events-auto">
            
            {/* Top Row: Era Name, Time, and Main Controls */}
            <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div className="text-center md:text-left">
                    <div className="text-xs font-bold text-blue-400 tracking-widest uppercase mb-1">ç•¶å‰ç´€å…ƒ</div>
                    <h2 className="text-2xl font-bold text-white">{currentEra.name}</h2>
                </div>
                
                <div className="flex-1 min-w-[200px] flex flex-col items-center justify-center">
                     <div className="text-4xl font-mono font-bold text-yellow-400">
                        {year} <span className="text-lg text-slate-400">Ma (ç™¾è¬å¹´å‰)</span>
                     </div>
                     {/* AI Actions Group */}
                     <div className="flex gap-3 mt-3">
                         {/* æ™‚ä»£é ­æ¢ç”Ÿæˆå™¨ */}
                         <button
                            onClick={generateEraHeadline}
                            disabled={isHeadlineLoading || isPlaying || isImageGenerating}
                            className="text-xs flex items-center gap-1 bg-purple-700 hover:bg-purple-600 disabled:bg-slate-700 disabled:text-slate-500 text-white px-3 py-1.5 rounded-full transition-colors font-semibold"
                         >
                            {isHeadlineLoading ? (
                                <>
                                    <RotateCcw className="animate-spin" size={12} /> é ­æ¢ä¸­...
                                </>
                            ) : (
                                <>
                                    <Sparkles size={12} /> æ™‚ä»£é ­æ¢
                                </>
                            )}
                         </button>
                         {/* æ™‚ä»£å½±åƒç”Ÿæˆå™¨ (åŠŸèƒ½ä¸‰) */}
                         <button
                            onClick={generateEraImage}
                            disabled={isImageGenerating || isPlaying || isHeadlineLoading}
                            className="text-xs flex items-center gap-1 bg-green-600 hover:bg-green-500 disabled:bg-slate-700 disabled:text-slate-500 text-white px-3 py-1.5 rounded-full transition-colors font-semibold"
                         >
                            {isImageGenerating ? (
                                <>
                                    <RotateCcw className="animate-spin" size={12} /> ç¹ªåœ–ä¸­...
                                </>
                            ) : (
                                <>
                                    <Sparkles size={12} /> ç”Ÿæˆå½±åƒ
                                </>
                            )}
                         </button>
                     </div>
                </div>

                <div className="flex gap-3">
                    <button 
                        onClick={() => setIsPlaying(!isPlaying)}
                        className={`flex items-center gap-2 px-6 py-2 rounded-full font-bold transition-all ${
                            isPlaying ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'
                        }`}
                    >
                        {isPlaying ? <><Pause size={18} /> æš«åœ</> : <><Play size={18} /> æ’­æ”¾æ¼”è®Š</>}
                    </button>
                    <button 
                        onClick={() => {setYear(250); setIsPlaying(false);}}
                        className="p-2 rounded-full bg-slate-700 hover:bg-slate-600 transition-colors text-slate-300"
                        title="é‡ç½®"
                    >
                        <RotateCcw size={18} />
                    </button>
                </div>
            </div>

            {/* åŠŸèƒ½äºŒçš„é¡¯ç¤ºå€åŸŸï¼šæ™‚ä»£é ­æ¢ */}
            {eraHeadline && (
                <div className="bg-purple-900/50 rounded-lg p-4 mb-4 border border-purple-700 shadow-md">
                    <h3 className="text-lg font-extrabold text-purple-300 mb-1 flex items-center gap-2">
                        <MessageSquare size={18} /> {eraHeadline.headline}
                    </h3>
                    <p className="text-sm text-purple-200 leading-relaxed">
                        {eraHeadline.summary}
                    </p>
                </div>
            )}
            
            {/* åŠŸèƒ½ä¸‰çš„é¡¯ç¤ºå€åŸŸï¼šæ™‚ä»£å½±åƒ */}
            {generatedImageURL && (
                <div className="mb-4 flex justify-center p-2">
                    <img 
                        src={generatedImageURL} 
                        alt={${currentEra.name} æ™‚ä»£å½±åƒ} 
                        className="w-full max-w-lg h-auto rounded-lg shadow-xl border-4 border-slate-700 object-cover" 
                    />
                </div>
            )}

            {/* Description Text */}
            <div className="bg-slate-900/50 rounded-lg p-3 mb-4 text-sm text-slate-300 border-l-4 border-blue-500">
                {currentEra.description}
            </div>

            {/* Slider Control */}
            <div className="relative pt-1">
                <input 
                    type="range" 
                    min="0" 
                    max="250" 
                    step="1"
                    value={year}
                    onChange={(e) => {
                        setYear(parseInt(e.target.value));
                        setIsPlaying(false);
                    }}
                    className="w-full h-3 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500 hover:accent-blue-400 transition-all"
                    style={{direction: 'rtl'}}
                />
                <div className="flex justify-between text-xs text-slate-500 mt-2 font-mono">
                    <span>250 Ma (ç›¤å¤å¤§é™¸)</span>
                    <span>150 Ma</span>
                    <span>65 Ma</span>
                    <span>0 Ma (ç¾ä»£)</span>
                </div>
            </div>

        </div>
      </div>

      {/* Styles - ç§»é™¤äº†å°è‡´è­¦å‘Šçš„å±¬æ€§ */}
      <style>{`
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            cursor: pointer;
            margin-top: -4px;
        }

        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }
      `}</style>
    </div>
  );
}
